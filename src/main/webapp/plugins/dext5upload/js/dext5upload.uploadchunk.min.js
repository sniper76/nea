importScripts("aes.js");importScripts("dext5upload.base64.js");importScripts("dext5upload.xhr.js");var numberOfServerUploadedChunks=0;
function buildFormData(c,g,f,d,e,m,h,k,q,t,r,l){var n=new FileReaderSync,b=n.readAsDataURL(c).match(/,(.*)$/)[1],u,p=function(){var a="";if("0"!=e.encryptParam){var c;c=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter);c+="d18"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter;c+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter;c+="d08"+Dext5Base64._trans_unitAttributeDelimiter+d+Dext5Base64._trans_unitDelimiter;
c+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter;c+="d38"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter;c+="d11"+Dext5Base64._trans_unitAttributeDelimiter+e.folderNameRule+Dext5Base64._trans_unitDelimiter;c+="d09"+Dext5Base64._trans_unitAttributeDelimiter+e.fileNameRule+Dext5Base64._trans_unitDelimiter;c+="d10"+Dext5Base64._trans_unitAttributeDelimiter+e.fileNameRuleEx+Dext5Base64._trans_unitDelimiter;c+="d35"+Dext5Base64._trans_unitAttributeDelimiter+
e.checkFileExtension+Dext5Base64._trans_unitDelimiter;c+="d37"+Dext5Base64._trans_unitAttributeDelimiter+e.uploadChunkSize+Dext5Base64._trans_unitDelimiter;c+="d47"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter;0<e.encryptFile&&(c+="d17"+Dext5Base64._trans_unitAttributeDelimiter+e.encryptFile+Dext5Base64._trans_unitDelimiter);c=Dext5Base64.makeEncryptParamFinal(e.encryptParam,c);a+="--"+m+'\r\nContent-Disposition: form-data; name="'+c.name+'"';a+="\r\n\r\n";a+=c.value;
a+="\r\n"}else a+="--"+m+'\r\nContent-Disposition: form-data; name="dext5CMD"',a+="\r\n",a+="\r\n",a+="uploadRequest",a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="chunkNumber"',a+="\r\n",a+="\r\n",a+=g,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="GUID"',a+="\r\n",a+="\r\n",a+=f,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileName"',a+="\r\n",a+="\r\n",a+=d,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="gpid"',a+="\r\n",a+="\r\n",
a+=q,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fidx"',a+="\r\n",a+="\r\n",a+=t,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="folderNameRule"',a+="\r\n",a+="\r\n",a+=e.folderNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRule"',a+="\r\n",a+="\r\n",a+=e.fileNameRule,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fileNameRuleEx"',a+="\r\n",a+="\r\n",a+=e.fileNameRuleEx,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cfe"',
a+="\r\n",a+="\r\n",a+=e.checkFileExtension,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="cs"',a+="\r\n",a+="\r\n",a+=e.uploadChunkSize,a+="\r\n",a+="--"+m+'\r\nContent-Disposition: form-data; name="fs"',a+="\r\n",a+="\r\n",a+=h,a+="\r\n",0<e.encryptFile&&(a+="--"+m+'\r\nContent-Disposition: form-data; name="fde"',a+="\r\n",a+="\r\n",a+=e.encryptFile,a+="\r\n");a+="--"+m+'\r\nContent-Disposition: form-data; name="mark"';a+="\r\n";a+="\r\n";a+=k;a+="\r\n";c=r.length;for(var u=0;u<
c;u++)a+="--"+m+'\r\nContent-Disposition: form-data; name="'+r[u].form_name+'"',a+="\r\n",a+="\r\n",a+=encodeURIComponent(r[u].form_value),a+="\r\n";a+="--"+m+'\r\nContent-Disposition: form-data; name="Slice"; filename="blob"';a+="\r\n";a+="Content-Type: application/octet-stream; charset=UTF-8";a+="\r\n";a+="\r\n";a+=b+"\r\n";a+="--"+m+"--\r\n";n=null;l(a)},w=function(a){b=n.readAsDataURL(a).match(/,(.*)$/)[1];p()};0<e.encryptFile?(u||(u=n.readAsArrayBuffer(c)),encryptFileData(u,e.ServerReleaseVer.substring(0,
11),16*e.encryptFile,w)):p()}function makeGuidTagName(c){var g=0,f=(new Date).getTime().toString(32),d;for(d=0;5>d;d++)f+=Math.floor(65535*Math.random()).toString(32);return(c||"o_")+f+(g++).toString(32)}
function upload_merge(c,g,f,d,e,m,h,k,q,t,r){var l=XHRFactory.getInstance();l.open("POST",e,m);l.onreadystatechange=function(b){if(4==l.readyState)if(200==l.status){var d=l.responseText;b=d.split("|");1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),d="success"==b.result?b.value:"error"==b.result?b.value:""==h.ServerReleaseVer||"2.7.1120889.1613.01">=h.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|"));if(0==d.indexOf("error"))self.postMessage({type:"error",
code:b[1],message:b[2],id:c}),XHRFactory.release(l),self.close();else{var e;e=b[0];var f=e.indexOf("::");-1<f?(d=e.substring(0,f),e=e.substring(f+2)):(d=g,e=b[0]);2==b.length?-1<b[1].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:b[1].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:"",uploadGroupId:""}):3==
b.length&&(-1<b[2].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2].split("\b")[0],uploadGroupId:b[2].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2],uploadGroupId:""}));XHRFactory.release(l)}}else if(400<=l.status&&600>l.status||0==l.status)d=l.responseText,b=d.split("|"),1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),
d="success"==b.result?b.value:"error"==b.result?b.value:""==h.ServerReleaseVer||"2.7.1120889.1613.01">=h.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|")),2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+b[1],id:c}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:c}):self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",id:c}),XHRFactory.release(l),self.close()};
"0"!=h.encryptParam?(e=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"mergeRequest"+Dext5Base64._trans_unitDelimiter),e+="d08"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter,e+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,e+="d19"+Dext5Base64._trans_unitAttributeDelimiter+d.numberOfChunks+Dext5Base64._trans_unitDelimiter,e+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter,e+="d38"+Dext5Base64._trans_unitAttributeDelimiter+
t+Dext5Base64._trans_unitDelimiter,e+="d11"+Dext5Base64._trans_unitAttributeDelimiter+h.folderNameRule+Dext5Base64._trans_unitDelimiter,e+="d09"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRule+Dext5Base64._trans_unitDelimiter,e+="d10"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(h.encryptParam,e),f=f.name+"="+f.value):(f="dext5CMD=mergeRequest&fileName="+encodeURIComponent(g)+"&GUID="+f+"&numberOfChunks="+
d.numberOfChunks+"&gpid="+q+"&fidx="+t,f+="&folderNameRule="+h.folderNameRule+"&fileNameRule="+h.fileNameRule+"&fileNameRuleEx="+h.fileNameRuleEx,0<h.encryptFile&&(f+="&fde="+h.encryptFile));"1"==h.integrity&&(f+="&fdi="+h.FDIData);f+="&mark="+k;k=r.length;for(d=0;d<k;d++)f+="&"+r[d].form_name+"="+encodeURIComponent(r[d].form_value);l.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{l.send(f)}catch(n){self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",
id:c}),XHRFactory.release(l),self.close()}}
function upload(c,g,f,d,e,m,h,k,q,t,r,l){var n=XHRFactory.getInstance(),b=f,b=-1<b.indexOf("?")?b+"&dext=slice":b+"?dext=slice",b=b+("&p="+makeGuidTagName("urk_"));n.open("POST",b,e);var u=c.size;n.onreadystatechange=function(){if(4==n.readyState)if(200==n.status){var a=n.responseText,b=a.split("|");1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(a),a="success"==b.result?b.value:"error"==b.result?b.value:""==k.ServerReleaseVer||"2.7.1120889.1613.01">=k.ServerReleaseVer?Dext5Base64.decode(a):
Dext5Base64.makeDecryptReponseMessage(a),b=a.split("|"));0==a.indexOf("error")?(self.postMessage({type:"error",code:b[1],message:b[2],id:m}),XHRFactory.release(n),self.close()):""!=n.responseText.replace(/ /g,"")?(self.postMessage({type:"error",code:"200018",message:"",id:m}),XHRFactory.release(n),self.close()):(numberOfServerUploadedChunks++,self.postMessage({type:"progress",uploadedChunks:numberOfServerUploadedChunks,uploadedSize:u,chunkInfo:d,id:m}),numberOfServerUploadedChunks==d.numberOfChunks&&
(upload_merge(m,g,h,d,f,e,k,q,t,r,l),numberOfServerUploadedChunks=0),XHRFactory.release(n))}else if(400<=n.status&&600>n.status||0==n.status)a=n.responseText,b=a.split("|"),1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(a),a="success"==b.result?b.value:"error"==b.result?b.value:""==k.ServerReleaseVer||"2.7.1120889.1613.01">=k.ServerReleaseVer?Dext5Base64.decode(a):Dext5Base64.makeDecryptReponseMessage(a),b=a.split("|")),2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+
b[1],id:m}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:m}):self.postMessage({type:"error",code:"000",message:"Upload Error: upload_merge",id:m}),XHRFactory.release(n),self.close()};var p="",w=function(){try{n.send(p)}catch(a){self.postMessage({type:"reupload",chunk:c,filename:g,chunkInfo:d,asyncstate:e,guid:h,configValues:k,id:m,mark:q,gpid:t,fidx:r}),XHRFactory.release(n)}p=c=null};if("undefined"==typeof FormData){var a=makeGuidTagName("----dext5_"),b=function(b){p=
b;n.setRequestHeader("Content-Type","multipart/form-data; boundary="+a);n.setRequestHeader("Dext5-Encoded","base64");w()};try{buildFormData(c,d.currentNumber,h,g,k,a,d.size,q,t,r,l,b)}catch(x){self.postMessage({type:"reupload",chunk:c,filename:g,chunkInfo:d,asyncstate:e,guid:h,configValues:k,id:m,mark:q,gpid:t,fidx:r})}}else{p=new FormData;"0"!=k.encryptParam?(b=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uploadRequest"+Dext5Base64._trans_unitDelimiter),b+="d18"+Dext5Base64._trans_unitAttributeDelimiter+
d.currentNumber+Dext5Base64._trans_unitDelimiter,b+="d07"+Dext5Base64._trans_unitAttributeDelimiter+h+Dext5Base64._trans_unitDelimiter,b+="d08"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter,b+="d12"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter,b+="d38"+Dext5Base64._trans_unitAttributeDelimiter+r+Dext5Base64._trans_unitDelimiter,b+="d11"+Dext5Base64._trans_unitAttributeDelimiter+k.folderNameRule+Dext5Base64._trans_unitDelimiter,b+="d09"+
Dext5Base64._trans_unitAttributeDelimiter+k.fileNameRule+Dext5Base64._trans_unitDelimiter,b+="d10"+Dext5Base64._trans_unitAttributeDelimiter+k.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,b+="d35"+Dext5Base64._trans_unitAttributeDelimiter+k.checkFileExtension+Dext5Base64._trans_unitDelimiter,b+="d37"+Dext5Base64._trans_unitAttributeDelimiter+k.uploadChunkSize+Dext5Base64._trans_unitDelimiter,b+="d47"+Dext5Base64._trans_unitAttributeDelimiter+d.size+Dext5Base64._trans_unitDelimiter,0<k.encryptFile&&
(b+="d17"+Dext5Base64._trans_unitAttributeDelimiter+k.encryptFile+Dext5Base64._trans_unitDelimiter),b=Dext5Base64.makeEncryptParamFinal(k.encryptParam,b),p.append(b.name,b.value)):(p.append("dext5CMD","uploadRequest"),p.append("chunkNumber",d.currentNumber),p.append("GUID",h),p.append("fileName",g),p.append("gpid",t),p.append("fidx",r),p.append("folderNameRule",k.folderNameRule),p.append("fileNameRule",k.fileNameRule),p.append("fileNameRuleEx",k.fileNameRuleEx),p.append("cfe",k.checkFileExtension),
p.append("cs",k.uploadChunkSize),p.append("fs",d.size),0<k.encryptFile&&p.append("fde",k.encryptFile));p.append("mark",q);for(var b=l.length,v=0;v<b;v++)p.append(l[v].form_name,encodeURIComponent(l[v].form_value));b=function(a){p.append("Slice",a);w()};0<k.encryptFile?(v=new FileReaderSync,v=v.readAsArrayBuffer(c),encryptFileData(v,k.ServerReleaseVer.substring(0,11),16*k.encryptFile,b),v=null):(p.append("Slice",c),w())}}
function uploadZeroFile(c,g,f,d,e,m,h,k,q,t,r){var l=XHRFactory.getInstance();l.open("POST",d,e);l.onreadystatechange=function(b){if(4==l.readyState)if(200==l.status){var d=l.responseText;b=d.split("|");1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),d="success"==b.result?b.value:"error"==b.result?b.value:""==h.ServerReleaseVer||"2.7.1120889.1613.01">=h.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|"));if(0==d.indexOf("error"))self.postMessage({type:"error",
code:b[1],message:b[2],id:c}),XHRFactory.release(l),self.close();else{var e;e=b[0];var f=e.indexOf("::");-1<f?(d=e.substring(0,f),e=e.substring(f+2)):(d=g,e=b[0]);2==b.length?-1<b[1].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1].split("\b")[0],uploadCustomValue:"",uploadGroupId:b[1].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:"",uploadGroupId:""}):3==
b.length&&(-1<b[2].indexOf("\b")?self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2].split("\b")[0],uploadGroupId:b[2].split("\b")[1]}):self.postMessage({type:"complete",id:c,originalFileName:d,uploadFilePath:e,uploadFileName:b[1],uploadCustomValue:b[2],uploadGroupId:""}));XHRFactory.release(l)}}else if(400<=l.status&&600>l.status||0==l.status)d=l.responseText,b=d.split("|"),1==b.length&&(b=Dext5Base64.makeDecryptReponseMessageEx2(d),
d="success"==b.result?b.value:"error"==b.result?b.value:""==h.ServerReleaseVer||"2.7.1120889.1613.01">=h.ServerReleaseVer?Dext5Base64.decode(d):Dext5Base64.makeDecryptReponseMessage(d),b=d.split("|")),2==b.length?self.postMessage({type:"error",code:b[0],message:"Upload Error: "+b[1],id:c}):3==b.length?self.postMessage({type:"error",code:b[1],message:"Upload Error: "+b[2],id:c}):self.postMessage({type:"error",code:"000",message:"Upload Error: uploadZeroFile",id:c}),XHRFactory.release(l),self.close()};
"0"!=h.encryptParam?(d=""+("d01"+Dext5Base64._trans_unitAttributeDelimiter+"uzr"+Dext5Base64._trans_unitDelimiter),d+="d08"+Dext5Base64._trans_unitAttributeDelimiter+g+Dext5Base64._trans_unitDelimiter,d+="d07"+Dext5Base64._trans_unitAttributeDelimiter+f+Dext5Base64._trans_unitDelimiter,d+="d12"+Dext5Base64._trans_unitAttributeDelimiter+q+Dext5Base64._trans_unitDelimiter,d+="d38"+Dext5Base64._trans_unitAttributeDelimiter+t+Dext5Base64._trans_unitDelimiter,d+="d11"+Dext5Base64._trans_unitAttributeDelimiter+
h.folderNameRule+Dext5Base64._trans_unitDelimiter,d+="d09"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRule+Dext5Base64._trans_unitDelimiter,d+="d10"+Dext5Base64._trans_unitAttributeDelimiter+h.fileNameRuleEx+Dext5Base64._trans_unitDelimiter,d+="d35"+Dext5Base64._trans_unitAttributeDelimiter+h.checkFileExtension+Dext5Base64._trans_unitDelimiter,f=Dext5Base64.makeEncryptParamFinal(h.encryptParam,d),f=f.name+"="+f.value):(f="dext5CMD=uzr&fileName="+encodeURIComponent(g)+"&GUID="+f+"&gpid="+
q+"&fidx="+t,f+="&folderNameRule="+h.folderNameRule+"&fileNameRule="+h.fileNameRule+"&fileNameRuleEx="+h.fileNameRuleEx,f+="&cfe="+h.checkFileExtension);f+="&mark="+k;k=r.length;for(q=0;q<k;q++)f+="&"+r[q].form_name+"="+encodeURIComponent(r[q].form_value);l.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8");try{l.send(f)}catch(n){self.postMessage({type:"error",code:"000",message:"Upload Error: uploadZeroFile",id:c}),XHRFactory.release(l),XHRFactory=null,self.close()}}
self.onmessage=function(c){c=c.data;switch(c.type){case "upload":upload(c.chunk,c.filename,c.handlerurl,c.chunkInfo,c.asyncstate,c.id,c.guid,c.configValues,c.mark,c.gpid,c.fidx,c.formDataEx);break;case "uploadZeroFile":self.postMessage({type:"progress",uploadedChunks:1,uploadedSize:0,chunkInfo:{currentNumber:1,numberOfChunks:1,size:0},id:c.id}),uploadZeroFile(c.id,c.filename,c.guid,c.handlerurl,c.asyncstate,c.blob,c.configValues,c.mark,c.gpid,c.fidx,c.formDataEx)}};
function encryptFileData(c,g,f,d){var e;try{e=crypto||msCrypto}catch(m){}if(e&&e.subtle){var h=stringToBytes(g);g=new Uint8Array(f);g.set(h);var k=e.subtle.importKey("raw",g,{name:"AES-CBC"},!1,["encrypt","decrypt"]);k.then(function(f){var g=new Uint8Array(16);g.set(h);e.subtle.encrypt({name:"AES-CBC",iv:g},f,c).then(function(c){c=makeBlob(c);d(c)})["catch"]=function(c){self.postMessage({type:"error",code:"C011",message:c.message||c,workerId:workerData.workerId})}})["catch"]=function(c){self.postMessage({type:"error",
code:"C011",message:c.message||c,workerId:workerData.workerId})}}else k=CryptoJS.enc.Utf8.parse(g),k.sigBytes=f,wordArrayData=function(c){c=new Uint8Array(c);for(var d=[],e=0;e<c.length;e+=4)d.push(c[e]<<24|c[e+1]<<16|c[e+2]<<8|c[e+3]);return CryptoJS.lib.WordArray.create(d,c.length)}(c),g=CryptoJS.AES.encrypt(wordArrayData,k,{iv:CryptoJS.enc.Utf8.parse(g)}),wordArrayData=void 0,g=makeBlob(function(c){var d=c.words.length,e=new Uint8Array(d<<2),f=0,g,b;for(b=0;b<d;b++)g=c.words[b],e[f++]=g>>24,e[f++]=
g>>16&255,e[f++]=g>>8&255,e[f++]=g&255;return e}(g.ciphertext)),d(g)}function arrayBufferToBase64(c){var g="";c=new Uint8Array(c);for(var f=c.byteLength,d=0;d<f;d++)g+=String.fromCharCode(c[d]);return btoa(g)}function stringToBytes(c){for(var g,f,d=[],e=0;e<c.length;e++){g=c.charCodeAt(e);f=[];do f.push(g&255),g>>=8;while(g);d=d.concat(f.reverse())}return d}var makeBlob=function(c){var g=[];g.push(c);return new Blob(g,{type:"application/octet-stream"})};
